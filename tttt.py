import json
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import io
import base64
from datetime import datetime

def visualize_portfolio_value(json_response_str: str, plot_title: str = "Portfolio Value Over Time") -> str:
    """
    Parses a JSON string containing portfolio data in the specified Zerion.io format,
    formats it, and creates a line chart of portfolio value over time.

    Args:
        json_response_str (str): The JSON response string from the Zerion.io API.
        plot_title (str): The title for the generated plot. Defaults to "Portfolio Value Over Time".

    Returns:
        str: A base64 encoded string of the generated plot image (PNG format).
             Returns an empty string if an error occurs.
    """
    try:
        # 1. Parse the JSON response
        data_json = json.loads(json_response_str)

        # Navigate to the 'points' array
        # The structure is data -> attributes -> points
        points_data = data_json.get("data", {}).get("attributes", {}).get("points")

        if not points_data:
            print("Error: 'points' data not found or is empty in the JSON response.")
            return ""

        # 2. Format the data nicely using pandas DataFrame
        # Each point is [timestamp, value]
        # Convert Unix timestamp to datetime objects
        # Create a list of dictionaries for DataFrame creation
        formatted_data = []
        for point in points_data:
            if len(point) == 2:
                timestamp = point[0]
                value = point[1]
                # Convert Unix timestamp (seconds) to datetime
                date_time = datetime.fromtimestamp(timestamp)
                formatted_data.append({"date": date_time, "value": value})
            else:
                print(f"Warning: Skipping malformed point: {point}")

        if not formatted_data:
            print("Error: No valid data points found after parsing 'points' array.")
            return ""

        df = pd.DataFrame(formatted_data)

        # Ensure 'value' column is numeric
        df['value'] = pd.to_numeric(df['value'], errors='coerce')
        df.dropna(subset=['date', 'value'], inplace=True) # Drop rows where value couldn't be converted

        # Sort data by date to ensure correct plotting order
        df.sort_values(by='date', inplace=True)

        # 3. Create a line chart for portfolio value over time
        plt.figure(figsize=(12, 7))
        sns.lineplot(x='date', y='value', data=df, marker='o', color='skyblue', linewidth=2)

        plt.title(plot_title, fontsize=18, fontweight='bold')
        plt.xlabel("Date", fontsize=14)
        plt.ylabel("Portfolio Value (USD)", fontsize=14) # Assuming currency is USD based on example link
        plt.grid(True, linestyle='--', alpha=0.7)
        plt.xticks(rotation=45, ha='right', fontsize=10) # Rotate x-axis labels for better readability
        plt.yticks(fontsize=10)
        plt.tight_layout() # Adjust layout to prevent labels from overlapping

        # Save the plot to a BytesIO object and then encode it to base64
        buffer = io.BytesIO()
        plt.savefig(buffer, format='png', bbox_inches='tight')
        plt.close() # Close the plot to free up memory
        buffer.seek(0)
        img_base64 = base64.b64encode(buffer.getvalue()).decode('utf-8')

        print(f"Portfolio value visualization '{plot_title}' created successfully.")
        return img_base64

    except json.JSONDecodeError:
        print("Error: Invalid JSON string provided.")
        return ""
    except Exception as e:
        print(f"An unexpected error occurred: {e}")
        return ""

# --- Example Usage ---
if __name__ == "__main__":
    # Example JSON response string (replace with actual API response)
    response = '''
{
  "links": {
    "self": "https://api.zerion.io/v1/wallets/0x5d39036947e83862ce5f3db351cc64e3d4592cd5/charts/week?currency=usd&filter%5Bchain_ids%5D=abstract%2Cape%2Carbitrum%2Caurora%2Cavalanche%2Cbase%2Cberachain%2Cbinance-smart-chain%2Cblast%2Ccelo%2Cdegen%2Cethereum%2Cfantom%2Cgravity-alpha%2Cink%2Clens%2Clinea%2Coptimism%2Cpolygon-zkevm%2Cpolygon%2Cscroll%2Csoneium%2Csonic%2Cunichain%2Cwonder%2Cworld%2Cxdai%2Cxinfin-xdc%2Czero%2Czksync-era%2Czora"
  },
  "data": {
    "type": "wallet_chart",
    "id": "0x5d39036947e83862ce5f3db351cc64e3d4592cd5-week",
    "attributes": {
      "begin_at": "2025-05-20T15:00:00Z",
      "end_at": "2025-05-27T15:00:00Z",
      "points": [
        [
          1747753200,
          147464.36935518478
        ],
        [
          1747755000,
          147389.25230780532
        ],
        [
          1747756800,
          148039.6875740267
        ],
        [
          1747758600,
          147547.127518553
        ],
        [
          1747760400,
          147326.35460272565
        ],
        [
          1747762200,
          147678.88769372265
        ],
        [
          1747764000,
          148198.48527404873
        ],
        [
          1747765800,
          149121.70641240352
        ],
        [
          1747767600,
          147454.01133805656
        ],
        [
          1747769400,
          147590.97632808436
        ],
        [
          1747771200,
          149189.93397994852
        ],
        [
          1747773000,
          151998.71722499243
        ],
        [
          1747774800,
          153617.09045710292
        ],
        [
          1747776600,
          153978.098841158
        ],
        [
          1747778400,
          154087.07599154278
        ],
        [
          1747780200,
          153322.04791451065
        ],
        [
          1747782000,
          153427.0705693888
        ],
        [
          1747783800,
          154177.52198174194
        ],
        [
          1747785600,
          153869.77004761057
        ],
        [
          1747787400,
          154009.6870058395
        ],
        [
          1747789200,
          153673.8545092302
        ],
        [
          1747791000,
          153757.04548176486
        ],
        [
          1747792800,
          153896.5336704944
        ],
        [
          1747794600,
          152974.0137191155
        ],
        [
          1747796400,
          153493.43720511615
        ],
        [
          1747798200,
          154281.01056047715
        ],
        [
          1747800000,
          154659.6750950363
        ],
        [
          1747801800,
          154392.90905532238
        ],
        [
          1747803600,
          154673.24295166184
        ],
        [
          1747805400,
          155511.65447765565
        ],
        [
          1747807200,
          156012.04316795876
        ],
        [
          1747809000,
          156188.7395068979
        ],
        [
          1747810800,
          156704.78466220954
        ],
        [
          1747812600,
          155467.7092403184
        ],
        [
          1747814400,
          154661.94998398877
        ],
        [
          1747816200,
          154595.47448571058
        ],
        [
          1747818000,
          153925.8112708021
        ],
        [
          1747819800,
          153393.76462408202
        ],
        [
          1747821600,
          153134.97820479417
        ],
        [
          1747823400,
          153126.73601807308
        ],
        [
          1747825200,
          153691.11037608734
        ],
        [
          1747827000,
          155094.8458313614
        ],
        [
          1747828800,
          155069.6769944384
        ],
        [
          1747830600,
          154853.43978625318
        ],
        [
          1747832400,
          154567.4252639961
        ],
        [
          1747834200,
          153864.40436146816
        ],
        [
          1747836000,
          167637.72414094376
        ],
        [
          1747837800,
          157180.17485350394
        ],
        [
          1747839600,
          156647.12395289753
        ],
        [
          1747841400,
          127516.25154388724
        ],
        [
          1747843200,
          127225.71395619861
        ],
        [
          1747845000,
          127691.36561378228
        ],
        [
          1747846800,
          129730.95410802873
        ],
        [
          1747848600,
          127055.46810352046
        ],
        [
          1747850400,
          124601.54858933412
        ],
        [
          1747852200,
          124990.45377802513
        ],
        [
          1747854000,
          125495.5116456065
        ],
        [
          1747855800,
          124799.89004622393
        ],
        [
          1747857600,
          126285.23373951037
        ],
        [
          1747859400,
          126797.35962938823
        ],
        [
          1747861200,
          126193.09200981827
        ],
        [
          1747863000,
          126584.89864060865
        ],
        [
          1747864800,
          126167.20765922035
        ],
        [
          1747866600,
          126487.52023012625
        ],
        [
          1747868400,
          127226.20183817443
        ],
        [
          1747870200,
          128218.6809336702
        ],
        [
          1747872000,
          128292.15959984143
        ],
        [
          1747873800,
          128225.64719413155
        ],
        [
          1747875600,
          128782.367223108
        ],
        [
          1747877400,
          129533.44085224211
        ],
        [
          1747879200,
          129221.63264994949
        ],
        [
          1747881000,
          129441.28809334559
        ],
        [
          1747882800,
          129662.71343288588
        ],
        [
          1747884600,
          129813.01165097434
        ],
        [
          1747886400,
          131168.61849172716
        ],
        [
          1747888200,
          130145.06925329844
        ],
        [
          1747890000,
          130600.440544427
        ],
        [
          1747891800,
          130693.59982965296
        ],
        [
          1747893600,
          130390.77518821995
        ],
        [
          1747895400,
          129318.49869618713
        ],
        [
          1747897200,
          129071.91405128414
        ],
        [
          1747899000,
          129175.66835935223
        ],
        [
          1747900800,
          129628.64539595191
        ],
        [
          1747902600,
          130380.20148548555
        ],
        [
          1747904400,
          130931.7484919562
        ],
        [
          1747906200,
          131858.9366994012
        ],
        [
          1747908000,
          131381.87933883158
        ],
        [
          1747909800,
          131290.22961805956
        ],
        [
          1747911600,
          130877.36828541354
        ],
        [
          1747913400,
          130114.92860119345
        ],
        [
          1747915200,
          130216.06343983047
        ],
        [
          1747917000,
          130040.78379155559
        ],
        [
          1747918800,
          130404.2216555178
        ],
        [
          1747920600,
          129736.18872403816
        ],
        [
          1747922400,
          169821.44365007817
        ],
        [
          1747924200,
          170036.05121254502
        ],
        [
          1747926000,
          171029.89965513183
        ],
        [
          1747927800,
          171382.00961685783
        ],
        [
          1747929600,
          171360.04426253572
        ],
        [
          1747931400,
          171217.34690667494
        ],
        [
          1747933200,
          170848.2787628902
        ],
        [
          1747935000,
          171223.93580971102
        ],
        [
          1747936800,
          171142.54748446523
        ],
        [
          1747938600,
          171187.2022036196
        ],
        [
          1747940400,
          179689.98657582878
        ],
        [
          1747942200,
          179399.9052194091
        ],
        [
          1747944000,
          178931.80324859958
        ],
        [
          1747945800,
          179411.65958201396
        ],
        [
          1747947600,
          179352.36827663518
        ],
        [
          1747949400,
          178961.1048744448
        ],
        [
          1747951200,
          178908.9967477776
        ],
        [
          1747953000,
          180088.59470171985
        ],
        [
          1747954800,
          180377.49718829006
        ],
        [
          1747956600,
          180500.52234138065
        ],
        [
          1747958400,
          181042.33554233145
        ],
        [
          1747960200,
          181299.31293506798
        ],
        [
          1747962000,
          181115.59523594874
        ],
        [
          1747963800,
          181439.7260807901
        ],
        [
          1747965600,
          182043.64461156164
        ],
        [
          1747967400,
          183467.94616432957
        ],
        [
          1747969200,
          183708.3580864536
        ],
        [
          1747971000,
          183699.87319205233
        ],
        [
          1747972800,
          183701.91490296184
        ],
        [
          1747974600,
          182899.37363477456
        ],
        [
          1747976400,
          181431.37607795518
        ],
        [
          1747978200,
          181585.8938245762
        ],
        [
          1747980000,
          181198.14537663347
        ],
        [
          1747981800,
          180159.4844323527
        ],
        [
          1747983600,
          179079.15766846944
        ],
        [
          1747985400,
          179782.06546757594
        ],
        [
          1747987200,
          179298.86320730273
        ],
        [
          1747989000,
          179535.60346517424
        ],
        [
          1747990800,
          140260.5854847403
        ],
        [
          1747992600,
          173806.05004010422
        ],
        [
          1747994400,
          174369.43772309655
        ],
        [
          1747996200,
          153651.01288853586
        ],
        [
          1747998000,
          153285.0254813424
        ],
        [
          1747999800,
          152491.23376398915
        ],
        [
          1748001600,
          149030.6707226789
        ],
        [
          1748003400,
          145269.7032261214
        ],
        [
          1748005200,
          145426.99232260714
        ],
        [
          1748007000,
          145617.33888470288
        ],
        [
          1748008800,
          146755.1928558952
        ],
        [
          1748010600,
          147265.3526772932
        ],
        [
          1748012400,
          149283.61478853828
        ],
        [
          1748014200,
          148617.92189781106
        ],
        [
          1748016000,
          148191.41913682147
        ],
        [
          1748017800,
          147194.88388669954
        ],
        [
          1748019600,
          147409.02030542024
        ],
        [
          1748021400,
          148535.50975532786
        ],
        [
          1748023200,
          148090.02385634516
        ],
        [
          1748025000,
          147802.89165715114
        ],
        [
          1748026800,
          147155.3418353345
        ],
        [
          1748028600,
          147254.76435932756
        ],
        [
          1748030400,
          146932.9367658571
        ],
        [
          1748032200,
          146278.34739758744
        ],
        [
          1748034000,
          145529.7453860928
        ],
        [
          1748035800,
          145282.56941876785
        ],
        [
          1748037600,
          145037.1577228251
        ],
        [
          1748039400,
          145623.85408913752
        ],
        [
          1748041200,
          144757.5884604375
        ],
        [
          1748043000,
          143845.9126400706
        ],
        [
          1748044800,
          142653.85825166255
        ],
        [
          1748046600,
          143283.2329314595
        ],
        [
          1748048400,
          143193.49574402013
        ],
        [
          1748050200,
          143404.14980122316
        ],
        [
          1748052000,
          143247.96841139472
        ],
        [
          1748053800,
          143306.96733143463
        ],
        [
          1748055600,
          143441.22232010314
        ],
        [
          1748057400,
          144191.1281680366
        ],
        [
          1748059200,
          144234.41977845103
        ],
        [
          1748061000,
          144328.76366661352
        ],
        [
          1748062800,
          144500.82658534276
        ],
        [
          1748064600,
          144111.90471352675
        ],
        [
          1748066400,
          143758.807532311
        ],
        [
          1748068200,
          143867.66291880416
        ],
        [
          1748070000,
          143256.08757714176
        ],
        [
          1748071800,
          144472.2860875345
        ],
        [
          1748073600,
          143883.16134384196
        ],
        [
          1748075400,
          143614.43138971925
        ],
        [
          1748077200,
          155222.4646795195
        ],
        [
          1748079000,
          155347.89801408476
        ],
        [
          1748080800,
          155274.3457993761
        ],
        [
          1748082600,
          155084.45807435553
        ],
        [
          1748084400,
          156271.24962617236
        ],
        [
          1748086200,
          156418.5754529901
        ],
        [
          1748088000,
          156522.7845571915
        ],
        [
          1748089800,
          156386.68430063367
        ],
        [
          1748091600,
          156288.0339407301
        ],
        [
          1748093400,
          156026.40969991538
        ],
        [
          1748095200,
          155700.23998586458
        ],
        [
          1748097000,
          155748.25190263655
        ],
        [
          1748098800,
          155960.2325814276
        ],
        [
          1748100600,
          155933.04251509343
        ],
        [
          1748102400,
          155531.68214607515
        ],
        [
          1748104200,
          155455.30786150045
        ],
        [
          1748106000,
          155721.09233076547
        ],
        [
          1748107800,
          155995.2649444566
        ],
        [
          1748109600,
          155763.26668379974
        ],
        [
          1748111400,
          155846.62702773465
        ],
        [
          1748113200,
          155244.84272886816
        ],
        [
          1748115000,
          161400.2878513258
        ],
        [
          1748116800,
          161388.50720968132
        ],
        [
          1748118600,
          161392.34455023755
        ],
        [
          1748120400,
          161571.4109574438
        ],
        [
          1748122200,
          160942.75108801993
        ],
        [
          1748124000,
          160740.55629600503
        ],
        [
          1748125800,
          160442.09276094293
        ],
        [
          1748127600,
          160376.5459244588
        ],
        [
          1748129400,
          160293.21844240333
        ],
        [
          1748131200,
          160188.7965644601
        ],
        [
          1748133000,
          160399.81275674963
        ],
        [
          1748134800,
          159096.13381064573
        ],
        [
          1748136600,
          158537.7365218157
        ],
        [
          1748138400,
          158598.36655956827
        ],
        [
          1748140200,
          158380.10463985824
        ],
        [
          1748142000,
          159108.8138954301
        ],
        [
          1748143800,
          159637.94875012132
        ],
        [
          1748145600,
          159972.99108269982
        ],
        [
          1748147400,
          159493.5779781224
        ],
        [
          1748149200,
          159694.24402048488
        ],
        [
          1748151000,
          159609.42512009593
        ],
        [
          1748152800,
          159658.31245898292
        ],
        [
          1748154600,
          159374.31443496674
        ],
        [
          1748156400,
          159574.26153099028
        ],
        [
          1748158200,
          159029.7709604789
        ],
        [
          1748160000,
          158775.34563360462
        ],
        [
          1748161800,
          158165.94279396438
        ],
        [
          1748163600,
          157352.60605752235
        ],
        [
          1748165400,
          157303.65795864596
        ],
        [
          1748167200,
          157347.30283385582
        ],
        [
          1748169000,
          157373.54555615922
        ],
        [
          1748170800,
          157206.62893894358
        ],
        [
          1748172600,
          157089.10642185612
        ],
        [
          1748174400,
          157065.46514054513
        ],
        [
          1748176200,
          157486.9880432583
        ],
        [
          1748178000,
          158203.36053865516
        ],
        [
          1748179800,
          158359.90736666962
        ],
        [
          1748181600,
          158878.08980158294
        ],
        [
          1748183400,
          158465.76607892322
        ],
        [
          1748185200,
          157676.6693113566
        ],
        [
          1748187000,
          156672.12437061252
        ],
        [
          1748188800,
          156905.48132030998
        ],
        [
          1748190600,
          156564.87989304672
        ],
        [
          1748192400,
          159503.63275878507
        ],
        [
          1748194200,
          159785.78175529468
        ],
        [
          1748196000,
          159792.6727953872
        ],
        [
          1748197800,
          160050.59744486873
        ],
        [
          1748199600,
          160206.5795577572
        ],
        [
          1748201400,
          160353.55861398284
        ],
        [
          1748203200,
          160727.7106504609
        ],
        [
          1748205000,
          160404.4543225399
        ],
        [
          1748206800,
          160518.8550947718
        ],
        [
          1748208600,
          160579.32896485119
        ],
        [
          1748210400,
          160368.98700290345
        ],
        [
          1748212200,
          162071.55313356087
        ],
        [
          1748214000,
          163262.88418744496
        ],
        [
          1748215800,
          163460.95140687205
        ],
        [
          1748217600,
          163993.9427801021
        ],
        [
          1748219400,
          164109.11429070993
        ],
        [
          1748221200,
          165069.6926233643
        ],
        [
          1748223000,
          165322.1298817042
        ],
        [
          1748224800,
          165945.5257579932
        ],
        [
          1748226600,
          165940.4281871729
        ],
        [
          1748228400,
          165468.80808580748
        ],
        [
          1748230200,
          165919.46925129357
        ],
        [
          1748232000,
          166362.7003136548
        ],
        [
          1748233800,
          166437.68869120307
        ],
        [
          1748235600,
          166363.37895816631
        ],
        [
          1748237400,
          167807.59697525692
        ],
        [
          1748239200,
          167440.01409863838
        ],
        [
          1748241000,
          167485.98016381837
        ],
        [
          1748242800,
          167343.9549386159
        ],
        [
          1748244600,
          168086.0343726962
        ],
        [
          1748246400,
          168110.69513368618
        ],
        [
          1748248200,
          167710.16267440646
        ],
        [
          1748250000,
          167340.516788543
        ],
        [
          1748251800,
          166831.1260267928
        ],
        [
          1748253600,
          166377.497345449
        ],
        [
          1748255400,
          171386.12420132858
        ],
        [
          1748257200,
          171150.30995858577
        ],
        [
          1748259000,
          171264.8643594667
        ],
        [
          1748260800,
          171194.52212518122
        ],
        [
          1748262600,
          170855.97603384347
        ],
        [
          1748264400,
          171030.89441771124
        ],
        [
          1748266200,
          170368.79610126803
        ],
        [
          1748268000,
          170660.60321697235
        ],
        [
          1748269800,
          169665.81755301848
        ],
        [
          1748271600,
          168103.68224876898
        ],
        [
          1748273400,
          168397.6870098192
        ],
        [
          1748275200,
          169794.61232235027
        ],
        [
          1748277000,
          169521.84618974107
        ],
        [
          1748278800,
          169556.4236556079
        ],
        [
          1748280600,
          169146.97474483287
        ],
        [
          1748282400,
          168179.79686955694
        ],
        [
          1748284200,
          168257.89950705244
        ],
        [
          1748286000,
          168553.25348498713
        ],
        [
          1748287800,
          168375.58601182283
        ],
        [
          1748289600,
          168384.37935666466
        ],
        [
          1748291400,
          168468.61549601695
        ],
        [
          1748293200,
          169035.9628471244
        ],
        [
          1748295000,
          169305.3860719379
        ],
        [
          1748296800,
          169235.08178945613
        ],
        [
          1748298600,
          169635.46386789737
        ],
        [
          1748300400,
          169156.01912909915
        ],
        [
          1748302200,
          168900.95880952073
        ],
        [
          1748304000,
          169454.30559916323
        ],
        [
          1748305800,
          169543.10787743368
        ],
        [
          1748307600,
          168991.8584848213
        ],
        [
          1748309400,
          167351.60414168827
        ],
        [
          1748311200,
          167507.69000134364
        ],
        [
          1748313000,
          168051.30914405477
        ],
        [
          1748314800,
          168251.9634318722
        ],
        [
          1748316600,
          168926.64702922932
        ],
        [
          1748318400,
          169059.39182226275
        ],
        [
          1748320200,
          169360.26557099674
        ],
        [
          1748322000,
          169535.39291067136
        ],
        [
          1748323800,
          169129.96784659885
        ],
        [
          1748325600,
          169681.54140603633
        ],
        [
          1748327400,
          171651.38068718533
        ],
        [
          1748329200,
          171598.96879727606
        ],
        [
          1748331000,
          171482.3837575254
        ],
        [
          1748332800,
          171974.01864139634
        ],
        [
          1748334600,
          172672.2084907507
        ],
        [
          1748336400,
          172532.97852543846
        ],
        [
          1748338200,
          172191.3645027096
        ],
        [
          1748340000,
          172314.89951727953
        ],
        [
          1748341800,
          172366.85632532308
        ],
        [
          1748343600,
          172497.83438435418
        ],
        [
          1748345400,
          172227.72329668232
        ],
        [
          1748347200,
          172677.7752486587
        ],
        [
          1748349000,
          172658.18591343804
        ],
        [
          1748350800,
          172419.22370827856
        ],
        [
          1748352600,
          173757.20653695703
        ],
        [
          1748354400,
          172957.4031749944
        ],
        [
          1748356200,
          172537.39977298593
        ],
        [
          1748358000,
          171915.43644610033
        ]
      ]
    }
  }
}
'''
    img_base64 = visualize_portfolio_value(response)
    if img_base64:
        print("Base64 encoded image:", img_base64)

    # decoding and saving the image to verify
    if img_base64:
        img_data = base64.b64decode(img_base64)
        with open("portfolio_value_plot.png", "wb") as f:
            f.write(img_data)
        print("Image saved as 'portfolio_value_plot.png'")
    